{% extends "authentication/base.html" %}
{% load static %}
{% load currency_filters %}

{% block title %}KoraQuest Dashboard{% endblock %}

{% block extra_head %}
<style>
    .koraquest-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .dashboard-header {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #4CAF50;
        margin-bottom: 10px;
    }
    
    .section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .section h2 {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .purchase-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #4CAF50;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .purchase-info strong {
        color: #333;
        font-size: 1.1em;
    }
    
    .status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
    }
      .status.awaiting {
        background: #fff3cd;
        color: #856404;
    }
    
    .status.out-for-delivery {
        background: #cce5ff;
        color: #004085;
    }
    
    .status.completed {
        background: #d4edda;
        color: #155724;
    }
    
    .btn {
        background: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .btn:hover {
        background: #45a049;
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
    }
    
    .btn-scan {
        background: linear-gradient(45deg, #FF6B6B, #FF8E53);
        font-size: 1.1em;
        padding: 15px 30px;
    }
    
    .scanner-section {
        background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        color: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .scanner-section h2 {
        color: white;
        border: none;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block koraquest_nav %}
<div class="koraquest-top-nav">
    <div class="koraquest-nav-content">
        <div class="koraquest-nav-title">
            <i class="bi bi-shield-check"></i>
            KoraQuest Control Center
        </div>
        <div class="koraquest-nav-actions">
            <a href="{% url 'koraquest_dashboard' %}" 
               class="koraquest-nav-btn {% if request.resolver_match.url_name == 'koraquest_dashboard' %}active{% endif %}">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{% url 'scan_qr_code' %}" 
               class="koraquest-nav-btn {% if request.resolver_match.url_name == 'scan_qr_code' %}active{% endif %}">
                <i class="bi bi-qr-code-scan"></i> QR Scanner
            </a>
            <a href="{% url 'koraquest_purchase_history' %}" 
               class="koraquest-nav-btn {% if request.resolver_match.url_name == 'koraquest_purchase_history' %}active{% endif %}">
                <i class="bi bi-clock-history"></i> History
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="koraquest-dashboard">
    <div class="dashboard-header">
        <h1>üè™ KoraQuest Dashboard</h1>
        <p>Managing marketplace transactions and verifications</p>
        <div style="margin-top: 1rem;">
            <a href="{% url 'sales_statistics' %}" class="btn" style="background: #4caf50; margin-right: 1rem;">
                üìä Commission Statistics
            </a>
            <a href="{% url 'scan_qr_code' %}" class="btn" style="background: #2196f3;">
                üì± QR Scanner
            </a>
        </div>
    </div>    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ awaiting_purchases.count }}</div>
            <div>Pending Pickups</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ awaiting_deliveries.count }}</div>
            <div>Awaiting Delivery</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ out_for_delivery.count }}</div>
            <div>Out for Delivery</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">RWF{{ total_commission|floatformat:2 }}</div>
            <div>Total Commission</div>
        </div>
    </div><!-- QR Scanner Section -->
    <div class="scanner-section">
        <h2>üì± QR Code Scanner</h2>
        <p>Scan customer QR codes to verify purchases and manage pickups</p>
        <a href="{% url 'scan_qr_code' %}" class="btn btn-scan">
            Start QR Scanner
        </a>
    </div>    <!-- Pending Purchases -->
    <div class="section">
        <h2>üì¶ Pending Pickups ({{ awaiting_purchases.count }})</h2>
        {% for purchase in awaiting_purchases %}
            <div class="purchase-item">
                <div class="purchase-info">
                    <strong>{{ purchase.product.title }}</strong><br>
                    <small>
                        Customer: {{ purchase.buyer.username }} | 
                        Order: {{ purchase.order_id }} | 
                        Qty: {{ purchase.quantity }} | 
                        Total: RWF{{ purchase.purchase_price|floatformat:2 }}
                    </small><br>
                    <span class="status awaiting">Awaiting Pickup</span>
                </div>
                <div>
                    <small>{{ purchase.created_at|date:"M d, H:i" }}</small>
                </div>
            </div>
        {% empty %}
            <p style="text-align: center; color: #666; margin: 20px 0;">
                No pending pickups at the moment
            </p>
        {% endfor %}
    </div>

    <!-- Awaiting Deliveries -->
    <div class="section">
        <h2>üöö Awaiting Delivery ({{ awaiting_deliveries.count }})</h2>
        {% for purchase in awaiting_deliveries %}
            <div class="purchase-item">
                <div class="purchase-info">
                    <strong>{{ purchase.product.title }}</strong><br>
                    <small>
                        Customer: {{ purchase.buyer.username }} | 
                        Order: {{ purchase.order_id }} | 
                        Qty: {{ purchase.quantity }} | 
                        Total: RWF{{ purchase.purchase_price|floatformat:2 }}
                        {% if purchase.delivery_address %}
                        <br>Address: {{ purchase.delivery_address|truncatechars:50 }}
                        {% endif %}
                    </small><br>
                    <span class="status awaiting">Awaiting Delivery</span>
                </div>
                <div>
                    <a href="{% url 'confirm_delivery' purchase.id %}" class="btn">Start Delivery</a>
                    <small>{{ purchase.created_at|date:"M d, H:i" }}</small>
                </div>
            </div>
        {% empty %}
            <p style="text-align: center; color: #666; margin: 20px 0;">
                No orders awaiting delivery
            </p>
        {% endfor %}
    </div>

    <!-- Out for Delivery -->
    <div class="section">
        <h2>üõµ Out for Delivery ({{ out_for_delivery.count }})</h2>
        {% for purchase in out_for_delivery %}
            <div class="purchase-item">
                <div class="purchase-info">
                    <strong>{{ purchase.product.title }}</strong><br>
                    <small>
                        Customer: {{ purchase.buyer.username }} | 
                        Order: {{ purchase.order_id }} | 
                        Qty: {{ purchase.quantity }} | 
                        Total: RWF{{ purchase.purchase_price|floatformat:2 }}
                        {% if purchase.delivery_address %}
                        <br>Address: {{ purchase.delivery_address|truncatechars:50 }}
                        {% endif %}
                    </small><br>
                    <span class="status out-for-delivery">Out for Delivery</span>
                </div>
                <div>
                    <a href="{% url 'confirm_delivery' purchase.id %}" class="btn">Confirm Delivery</a>
                    <small>{{ purchase.created_at|date:"M d, H:i" }}</small>
                </div>
            </div>
        {% empty %}
            <p style="text-align: center; color: #666; margin: 20px 0;">
                No orders out for delivery
            </p>
        {% endfor %}
    </div><!-- Recent Completed Purchases -->
    <div class="section">
        <h2>‚úÖ Recent Completed Purchases</h2>
        {% for purchase in completed_purchases|slice:":10" %}
            <div class="purchase-item">
                <div class="purchase-info">
                    <strong>{{ purchase.product.title }}</strong><br>
                    <small>
                        Customer: {{ purchase.buyer.username }} | 
                        Order: {{ purchase.order_id }} | 
                        Vendor Payment: RWF{{ purchase.vendor_payment_amount|floatformat:2 }} | 
                        Commission: RWF{{ purchase.koraquest_commission_amount|floatformat:2 }}
                    </small><br>
                    <span class="status completed">Completed</span>
                </div>
                <div>
                    <small>{{ purchase.pickup_confirmed_at|date:"M d, H:i" }}</small>
                </div>
            </div>
        {% empty %}
            <p style="text-align: center; color: #666; margin: 20px 0;">
                No completed purchases yet
            </p>
        {% endfor %}
    </div>

    <!-- Product Review Section -->
    <div class="section">
        <h2>üîç Products Pending Review</h2>
        <p>Vendors have created these products but they need physical verification before being made available.</p>
        {% for product in pending_products|slice:":5" %}
            <div class="purchase-item">
                <div class="purchase-info">
                    <strong>{{ product.title }}</strong><br>
                    <small>
                        Vendor: {{ product.user.username }} | 
                        Price: RWF{{ product.price|floatformat:2 }} | 
                        Category: {{ product.category|default:"N/A" }}
                    </small>
                </div>
                <div>
                    <a href="{% url 'post_detail' product.id %}" class="btn">Review</a>
                </div>
            </div>
        {% empty %}
            <p style="text-align: center; color: #666; margin: 20px 0;">
                No products pending review
            </p>
        {% endfor %}
    </div>

    <!-- Navigation -->
    <div style="text-align: center; margin-top: 30px;">
        <a href="{% url 'dashboard' %}" class="btn">Back to Main Dashboard</a>
        <a href="{% url 'scan_qr_code' %}" class="btn" style="background: #4caf50;">QR Scanner</a>
        <a href="{% url 'koraquest_purchase_history' %}" class="btn">Purchase History</a>
    </div>
</div>
{% endblock %}
