{% extends "authentication/base.html" %}
{% load static %}

{% block title %}Account Settings - KoraQuest{% endblock %}

{% block content %}
<style>
    /* Base Colors and Variables */
    :root {
        --primary-color: #0f172a;
        --primary-light: #1e293b;
        --accent-color: #3b82f6;
        --accent-light: #60a5fa;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
        --background-light: #f8fafc;
        --background-white: #ffffff;
        --success-color: #059669;
        --error-color: #dc2626;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* Reset Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--background-light);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--text-secondary);
        border-radius: 4px;
    }

    .marketplace-container {
        width: 100%;
        background: white;
        min-height: 100vh;
        padding: 2rem;
    }

    .settings-grid {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        margin: 0 auto;
    }

    /* Navigation Styles */
    .nav-card {
        background: var(--background-white);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-md);
        position: sticky;
        top: 20px;
        border: 1px solid var(--border-color);
    }

    .nav-header {
        background: var(--primary-color);
        color: white;
        padding: 2rem;
    }

    .user-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 1rem;
    }

    .user-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .user-avatar:hover {
        transform: scale(1.05);
        opacity: 0.8;
    }

    .user-avatar-container {
        position: relative;
        display: inline-block;
    }

    .user-avatar-container::after {
        content: '\F1B8';
        font-family: 'bootstrap-icons';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 1.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .user-avatar-container:hover::after {
        opacity: 1;
    }

    .hidden-input {
        display: none;
    }

    .user-avatar-placeholder {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 600;
        color: white;
        border: 3px solid rgba(255, 255, 255, 0.1);
    }

    .user-details h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .user-role {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.25rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
    }

    .nav-menu {
        padding: 1rem;
    }

    .nav-link {
        width: 100%;
        padding: 0.875rem 1.25rem;
        border: none;
        background: none;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
        margin-bottom: 0.5rem;
    }

    .nav-link:hover {
        background: var(--background-light);
        color: var(--text-primary);
    }

    .nav-link.active {
        background: var(--primary-color);
        color: white;
    }

    /* Content Styles */
    .content-card {
        background: var(--background-white);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }

    .card-header {
        padding: 2rem;
        background: var(--background-light);
        border-bottom: 1px solid var(--border-color);
    }

    .card-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .card-header p {
        color: var(--text-secondary);
        margin: 0;
    }

    .settings-form {
        padding: 2rem;
    }

    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--background-light);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .form-section h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .form-field {
        margin-bottom: 1.5rem;
    }

    .form-field label {
        display: block;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .form-field input,
    .form-field textarea,
    .form-field select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--background-white);
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .form-field input:focus,
    .form-field textarea:focus,
    .form-field select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .field-hint {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
    }

    .form-field.span-2 {
        grid-column: span 2;
    }

    /* CV Section Styles */
    .cv-section {
        margin-bottom: 2rem;
    }

    .current-cv {
        margin-bottom: 1.5rem;
    }

    .cv-preview {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--background-white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .cv-preview i {
        font-size: 2rem;
        color: var(--accent-color);
    }

    .cv-info {
        flex: 1;
    }

    .cv-info h4 {
        margin: 0 0 0.25rem 0;
        font-weight: 600;
        color: var(--text-primary);
    }

    .cv-info span {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .btn-view {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--accent-color);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .btn-view:hover {
        background: var(--accent-light);
        color: white;
        text-decoration: none;
    }

    .cv-empty {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: #fef3cd;
        border: 1px solid #fdd835;
        border-radius: 8px;
        color: #8b5a2b;
    }

    /* File Upload Styles */
    .file-upload-container {
        position: relative;
    }

    .file-upload-container input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .upload-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        background: var(--background-light);
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .upload-placeholder:hover {
        border-color: var(--accent-color);
        background: var(--background-white);
    }

    .upload-placeholder i {
        font-size: 2rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .upload-placeholder span {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .upload-placeholder small {
        color: var(--text-secondary);
        font-size: 0.75rem;
    }

    /* Upgrade Section Styles */
    .upgrade-options {
        margin-bottom: 2rem;
    }

    .upgrade-card {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        background: var(--background-white);
        transition: all 0.2s ease;
    }

    .upgrade-card.active {
        border-color: var(--success-color);
        background: #f0fdf4;
    }

    .upgrade-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .upgrade-header i {
        font-size: 1.5rem;
        color: var(--accent-color);
    }

    .upgrade-header h3 {
        margin: 0;
        flex: 1;
    }

    .status-badge {
        background: var(--success-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .upgrade-features ul {
        list-style: none;
        padding: 0;
        margin: 0 0 1.5rem 0;
    }

    .upgrade-features li {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        color: var(--text-secondary);
    }

    .upgrade-features li i {
        color: var(--success-color);
    }

    .upgrade-status {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: #dcfce7;
        border-radius: 8px;
        color: var(--success-color);
        font-weight: 500;
    }

    .upgrade-form .terms-check {
        margin-bottom: 1rem;
    }

    .upgrade-form .terms-check input {
        margin-right: 0.5rem;
    }

    .btn-upgrade {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-upgrade:hover {
        background: var(--accent-light);
    }

    .upgrade-note {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .upgrade-note i {
        color: var(--accent-color);
        margin-top: 0.125rem;
    }

    .upgrade-note p {
        margin: 0;
        color: var(--text-secondary);
    }

    /* Profile Image Section */
    .profile-image-section {
        display: flex;
        align-items: center;
        gap: 2rem;
        padding: 1.5rem;
        background: var(--background-white);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .upload-label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: var(--primary-color);
        color: white;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .upload-label:hover {
        background: var(--primary-light);
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-primary:hover {
        background: var(--primary-light);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .marketplace-container {
            padding: 1.5rem;
        }
        .content-card, .nav-card {
            border-radius: 10px;
        }
    }
    @media (max-width: 992px) {
        .settings-grid {
            flex-direction: column;
            align-items: stretch;
        }
        .nav-card {
            position: static;
            margin-bottom: 1.5rem;
        }
        .nav-menu {
            display: flex;
            overflow-x: auto;
            padding: 1rem;
            gap: 0.75rem;
        }
        .nav-link {
            flex: 0 0 auto;
            margin: 0;
        }
    }
    @media (max-width: 768px) {
        .marketplace-container {
            padding: 0.5rem;
        }
        .settings-grid {
            flex-direction: column;
            align-items: stretch;
        }
        .content-card, .nav-card {
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }
        .card-header, .settings-form, .form-section {
            padding: 1rem;
        }
        .form-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .profile-image-section {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
    }
    @media (max-width: 480px) {
        .marketplace-container {
            padding: 0.25rem;
        }
        .content-card, .nav-card {
            border-radius: 5px;
            box-shadow: none;
        }
        .card-header, .settings-form, .form-section {
            padding: 0.5rem;
        }
        .form-section h3, .card-header h2 {
            font-size: 1rem;
        }
        .user-avatar, .user-avatar-placeholder {
            width: 60px;
            height: 60px;
            font-size: 1.2rem;
        }
    }
    @media (max-width: 700px) {
        .form-grid {
            grid-template-columns: 1fr !important;
        }
        .form-field {
            margin-bottom: 1rem;
        }
    }
    @media (max-width: 800px) {
        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .form-field {
            width: 100%;
        }
    }

    /* Settings Section Styles */
    .settings-section {
        display: block;
        opacity: 1;
        transform: translateY(0);
        margin-bottom: 2rem;
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="marketplace-container">
    <div class="settings-grid">

        <!-- Settings Content -->
        <div class="settings-content">
            <!-- Profile Section -->
            <div class="settings-section" id="profile">
                <div class="content-card">
                    <div class="card-header">
                        <div class="user-info">
                        {% if user.profile_picture %}
                        <div class="user-avatar-container" onclick="document.getElementById('profile_picture').click();" title="Click to change profile picture">
                            <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" class="user-avatar">
                        </div>
                        {% else %}
                        <div class="user-avatar-placeholder" onclick="document.getElementById('profile_picture').click();" title="Click to upload profile picture" style="cursor: pointer;">
                            {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                        </div>
                        {% endif %}
                        <div class="user-details">
                            <h2>{{ user.first_name }} {{ user.last_name }}</h2>
                            <span class="user-role">{{ user.get_role_display }}</span>
                        </div>
                    </div>
                    </div>
                    
                    <form method="POST" enctype="multipart/form-data" class="settings-form" id="profile-form">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="profile">
                        
                        <div class="form-section">
                            <h3>Profile Picture</h3>
                            <div class="profile-image-section">
                                <input type="file" id="profile_picture" name="profile_picture" accept="image/*" class="hidden-input">
                                <div class="upload-info">
                                    <p>Click on your profile picture above to change it, or use the button below.</p>
                                    <label for="profile_picture" class="upload-label">
                                        <i class="bi bi-camera"></i>
                                        Choose New Picture
                                    </label>
                                    <div class="field-hint">Maximum file size: 5MB. Supported formats: JPG, PNG, GIF</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Personal Information</h3>
                            <div class="form-grid">
                                <div class="form-field">
                                    <label for="first_name">First Name</label>
                                    <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" placeholder="Enter your first name">
                                </div>
                                
                                <div class="form-field">
                                    <label for="last_name">Last Name</label>
                                    <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" placeholder="Enter your last name">
                                </div>
                                
                                <div class="form-field span-2">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email" value="{{ user.email }}" placeholder="Enter your email address">
                                    <span class="field-hint">This email will be used for important notifications</span>
                                </div>
                                
                                <div class="form-field span-2">
                                    <label for="phone_number">Phone Number</label>
                                    <input type="tel" id="phone_number" name="phone_number" value="{{ user.phone_number }}" placeholder="Enter your phone number">
                                    <span class="field-hint">Optional: Used for account recovery and notifications</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">
                                <i class="bi bi-check-lg"></i>
                                <span>Save Changes</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Account Section -->
            <div class="settings-section" id="account">
                <div class="content-card">
                    <div class="card-header">
                        <h2>Account Settings</h2>
                        <p>Manage your account security and password</p>
                    </div>
                    
                    <form method="POST" class="settings-form">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="account">
                        
                        <div class="form-section">
                            <h3>Account Information</h3>
                            <div class="form-field">
                                <label for="username">Username</label>
                                <input type="text" id="username" name="username" value="{{ user.username }}" readonly>
                                <span class="field-hint">Username cannot be changed after account creation</span>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3>Change Password</h3>
                            <div class="form-field">
                                <label for="new_password">New Password</label>
                                <input type="password" id="new_password" name="new_password" placeholder="Enter a strong new password">
                                <span class="field-hint">Password should be at least 8 characters long</span>
                            </div>
                            
                            <div class="form-field">
                                <label for="confirm_password">Confirm New Password</label>
                                <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm your new password">
                                <span class="field-hint">Re-enter your new password to confirm</span>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">
                                <i class="bi bi-shield-check"></i>
                                <span>Update Password</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Freelancer Section -->
            {% if user.is_freelancer_role %}
            <div class="settings-section" id="freelancer">
                <div class="content-card">
                    <div class="card-header">
                        <h2>Freelancer Profile</h2>
                        <p>Manage your professional profile and showcase your skills</p>
                    </div>
                    
                    <form method="POST" enctype="multipart/form-data" class="settings-form">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="freelancer_profile">
                        
                        <div class="form-section">
                            <div class="cv-section">
                                <h3>CV / Resume</h3>
                                
                                {% if user.freelancer_cv %}
                                <div class="current-cv">
                                    <div class="cv-preview">
                                        <i class="bi bi-file-earmark-pdf"></i>
                                        <div class="cv-info">
                                            <h4>{{ user.freelancer_cv.name|slice:"4:" }}</h4>
                                            <span>Uploaded on: {{ user.freelancer_cv.name|date:"M d, Y" }}</span>
                                        </div>
                                        <a href="{{ user.freelancer_cv.url }}" target="_blank" class="btn-view">
                                            <i class="bi bi-eye"></i>
                                            <span>View</span>
                                        </a>
                                    </div>
                                </div>
                                {% else %}
                                <div class="cv-empty">
                                    <i class="bi bi-exclamation-circle"></i>
                                    <span>No CV uploaded yet</span>
                                </div>
                                {% endif %}
                                
                                <div class="form-field">
                                    <label for="freelancer_cv">Update Your CV</label>
                                    <div class="file-upload-container">
                                        <input type="file" id="freelancer_cv" name="freelancer_cv" accept=".pdf,.doc,.docx">
                                        <div class="upload-placeholder">
                                            <i class="bi bi-file-earmark-text"></i>
                                            <span>Upload a new CV</span>
                                            <small>PDF, DOC, or DOCX format recommended</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="skills-section">
                                <h3>Skills & Expertise</h3>
                                
                                <div class="form-field">
                                    <label for="freelancer_skills">Professional Skills</label>
                                    <textarea id="freelancer_skills" name="freelancer_skills" rows="5" placeholder="E.g., Web Development, Graphic Design, Content Writing, Project Management">{{ user.freelancer_skills }}</textarea>
                                    <span class="field-hint">List your key professional skills (comma separated) to help clients find you</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">
                                <i class="bi bi-check-lg"></i>
                                <span>Update Profile</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
            
            <!-- Upgrade Section -->
            <div class="settings-section" id="upgrade">
                <div class="content-card">
                    <div class="card-header">
                        <h2>Account Upgrade</h2>
                        <p>Unlock additional features and expand your opportunities</p>
                    </div>
                    
                    <div class="settings-form">
                        <div class="upgrade-options">
                            <div class="upgrade-card {% if user.is_vendor_role %}active{% endif %}">
                                <div class="upgrade-header">
                                    <i class="bi bi-shop"></i>
                                    <h3>Vendor Account</h3>
                                    {% if user.is_vendor_role %}
                                    <span class="status-badge">Active</span>
                                    {% endif %}
                                </div>
                                
                                <div class="upgrade-features">
                                    <ul>
                                        <li><i class="bi bi-check-circle"></i>Create and manage product listings</li>
                                        <li><i class="bi bi-check-circle"></i>Connect directly with buyers</li>
                                        <li><i class="bi bi-check-circle"></i>Build and showcase your brand</li>
                                        <li><i class="bi bi-check-circle"></i>Access detailed analytics and insights</li>
                                        <li><i class="bi bi-check-circle"></i>Priority customer support</li>
                                    </ul>
                                </div>
                                
                                {% if user.is_vendor_role %}
                                <div class="upgrade-status">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>You are already a vendor! Start selling today.</span>
                                </div>
                                {% else %}
                                <form method="POST" class="upgrade-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="upgrade_type" value="vendor">
                                    <div class="terms-check">
                                        <input type="checkbox" id="vendor_terms" required>
                                        <label for="vendor_terms">I agree to the <a href="#">Terms of Service</a> and <a href="#">Vendor Guidelines</a></label>
                                    </div>
                                    <button type="submit" class="btn-upgrade">
                                        <i class="bi bi-arrow-up-circle"></i>
                                        Become a Vendor
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="upgrade-note">
                            <i class="bi bi-info-circle"></i>
                            <p><strong>Multi-Role Support:</strong> You can have multiple roles on KoraQuest. For example, you can be both a vendor and a buyer to maximize your earning potential.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Profile Picture Preview and Auto-Submit
        const profilePicInput = document.getElementById('profile_picture');
        const profileForm = document.getElementById('profile-form');
        
        if (profilePicInput && profileForm) {
            profilePicInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select a valid image file.');
                        this.value = '';
                        return;
                    }
                    
                    // Validate file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB.');
                        this.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Update the profile picture preview
                        const mainAvatar = document.querySelector('.user-avatar');
                        const avatarPlaceholder = document.querySelector('.user-avatar-placeholder');
                        
                        if (mainAvatar) {
                            mainAvatar.src = e.target.result;
                        } else if (avatarPlaceholder) {
                            // Replace placeholder with actual image
                            const container = avatarPlaceholder.parentNode;
                            container.innerHTML = `<img src="${e.target.result}" alt="Profile preview" class="user-avatar">`;
                        }
                        
                        // Auto-submit the form when profile picture is selected
                        if (confirm('Do you want to upload this profile picture?')) {
                            // Create a new FormData object with just the profile picture
                            const formData = new FormData();
                            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                            formData.append('form_type', 'profile_picture');
                            formData.append('profile_picture', file);
                            
                            // Submit via AJAX to avoid losing other form data
                            fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Show success message
                                    showMessage('Profile picture updated successfully!', 'success');
                                } else {
                                    showMessage(data.error || 'Failed to update profile picture.', 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showMessage('An error occurred while uploading the image.', 'error');
                            });
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Function to show messages
        function showMessage(message, type) {
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                background: ${type === 'success' ? '#10b981' : '#dc2626'};
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                animation: slideIn 0.3s ease-out;
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }, 300);
                }
            }, 5000);
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // CV Upload Preview
        const cvInput = document.getElementById('freelancer_cv');
        if (cvInput) {
            cvInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    const placeholder = this.closest('.file-upload-container').querySelector('.upload-placeholder');
                    placeholder.innerHTML = `
                        <i class="bi bi-file-earmark-check" style="color: #10b981;"></i>
                        <span style="color: #10b981;">${fileName}</span>
                        <small>Click to change file</small>
                    `;
                    placeholder.style.borderColor = '#10b981';
                    placeholder.style.background = '#f0fdf4';
                }
            });
        }
        
        // File Upload Drag & Drop
        const uploadContainers = document.querySelectorAll('.file-upload-container');
        uploadContainers.forEach(container => {
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#2563eb';
                this.style.background = '#eff6ff';
            });
            
            container.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#e5e7eb';
                this.style.background = '#f9fafb';
            });
            
            container.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#e5e7eb';
                this.style.background = '#f9fafb';
                
                const input = this.querySelector('input[type="file"]');
                const files = e.dataTransfer.files;
                
                if (files.length > 0) {
                    input.files = files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        });

        // Handle form submissions
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
                    
                    // Re-enable after 3 seconds if form hasn't redirected
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }, 3000);
                }
            });
        });
        
        // Password confirmation validation
        const newPassword = document.getElementById('new_password');
        const confirmPassword = document.getElementById('confirm_password');
        
        if (newPassword && confirmPassword) {
            function validatePasswords() {
                if (confirmPassword.value && newPassword.value !== confirmPassword.value) {
                    confirmPassword.setCustomValidity('Passwords do not match');
                    confirmPassword.style.borderColor = '#dc2626';
                } else {
                    confirmPassword.setCustomValidity('');
                    confirmPassword.style.borderColor = '#e5e7eb';
                }
            }
            
            newPassword.addEventListener('input', validatePasswords);
            confirmPassword.addEventListener('input', validatePasswords);
        }
    });
</script>
{% endblock %}